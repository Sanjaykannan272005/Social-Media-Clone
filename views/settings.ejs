<%- include('partials/header') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-3">
      <!-- User profile card -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <img src="<%= user.avatar || '/images/default-avatar.png' %>" class="rounded-circle mb-3" width="100" height="100" alt="<%= user.username %>">
          <h5 class="card-title"><%= user.username %></h5>
          <p class="card-text text-muted"><%= user.email %></p>
        </div>
      </div>
      
      <!-- Navigation -->
      <div class="list-group mb-4">
        <a href="/dashboard" class="list-group-item list-group-item-action">
          <i class="fas fa-home me-2"></i> Home
        </a>
        <a href="/posts" class="list-group-item list-group-item-action">
          <i class="fas fa-newspaper me-2"></i> Posts
        </a>
        <a href="/messages" class="list-group-item list-group-item-action">
          <i class="fas fa-envelope me-2"></i> Messages
        </a>
        <a href="/profile" class="list-group-item list-group-item-action">
          <i class="fas fa-user me-2"></i> Profile
        </a>
        <a href="/settings" class="list-group-item list-group-item-action active">
          <i class="fas fa-cog me-2"></i> Settings
        </a>
      </div>
    </div>
    
    <div class="col-md-9">
      <% if (message) { %>
        <div class="alert <%= message.includes('success') ? 'alert-success' : 'alert-danger' %> alert-dismissible fade show" role="alert">
          <%= message %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <!-- Settings Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Account Privacy</h5>
        </div>
        <div class="card-body">
          <form action="/settings/privacy" method="POST">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="privacySwitch" name="isPrivate" value="true" <%= user.is_private ? 'checked' : '' %>>
              <label class="form-check-label" for="privacySwitch">
                Private Account
              </label>
              <small class="form-text text-muted d-block">
                When your account is private, only approved followers can see your posts and profile information.
              </small>
            </div>
            <button type="submit" class="btn btn-primary">Save Privacy Settings</button>
          </form>
        </div>
      </div>
      
      <!-- Change Password Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Change Password</h5>
        </div>
        <div class="card-body">
          <form action="/settings/password" method="POST">
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Current Password</label>
              <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">New Password</label>
              <input type="password" class="form-control" id="newPassword" name="newPassword" required>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Change Password</button>
          </form>
        </div>
      </div>
      
      <!-- Blocked Users Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Blocked Users</h5>
        </div>
        <div class="card-body">
          <div id="blockedUsers">
            <div class="text-center py-3">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Logout Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Session</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Sign out of your account on this device.</p>
          <a href="/logout" class="btn btn-secondary">Logout</a>
        </div>
      </div>
      
      <!-- Account Status Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Account Status</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Account Type:</strong> <%= user.is_private ? 'Private' : 'Public' %></p>
              <p><strong>Verification:</strong> <%= user.is_verified ? 'Verified' : 'Not Verified' %></p>
              <p><strong>Member Since:</strong> <%= new Date(user.created_at).toLocaleDateString() %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Posts:</strong> <span id="userPostsCount">Loading...</span></p>
              <p><strong>Followers:</strong> <span id="userFollowersCount">Loading...</span></p>
              <p><strong>Following:</strong> <span id="userFollowingCount">Loading...</span></p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Help Center Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Help Center</h5>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#helpModal" data-help="privacy">
              <i class="fas fa-shield-alt me-2"></i> Privacy & Security
            </a>
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#helpModal" data-help="account">
              <i class="fas fa-user-cog me-2"></i> Account Management
            </a>
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#helpModal" data-help="posting">
              <i class="fas fa-edit me-2"></i> Posting & Sharing
            </a>
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#helpModal" data-help="blocking">
              <i class="fas fa-ban me-2"></i> Blocking & Reporting
            </a>
          </div>
        </div>
      </div>
      
      <!-- About Us Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">About Us</h5>
        </div>
        <div class="card-body">
          <p class="mb-3">Social App - Connect with friends and share your moments.</p>
          <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#aboutModal" data-about="terms">
              <i class="fas fa-file-contract me-2"></i> Terms of Service
            </a>
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#aboutModal" data-about="privacy">
              <i class="fas fa-user-secret me-2"></i> Privacy Policy
            </a>
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#aboutModal" data-about="contact">
              <i class="fas fa-envelope me-2"></i> Contact Us
            </a>
            <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#aboutModal" data-about="version">
              <i class="fas fa-info-circle me-2"></i> App Version
            </a>
          </div>
        </div>
      </div>
      
      <!-- Delete Account Card -->
      <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Delete Account</h5>
        </div>
        <div class="card-body">
          <p class="text-danger">
            <strong>Warning:</strong> This action cannot be undone. All your data, posts, comments, and messages will be permanently deleted.
          </p>
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
            Delete My Account
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteAccountModalLabel">Confirm Account Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete your account? This action cannot be undone.</p>
        <form id="deleteAccountForm" action="/settings/delete-account" method="POST">
          <div class="mb-3">
            <label for="password" class="form-label">Enter your password to confirm:</label>
            <input type="password" class="form-control" id="password" name="password" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="deleteAccountForm" class="btn btn-danger">Delete Account</button>
      </div>
    </div>
  </div>
</div>

<!-- Help Center Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">Help Center</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="helpModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- About Us Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aboutModalLabel">About Us</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="aboutModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
  // Password change validation
  document.querySelector('form[action="/settings/password"]').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
      e.preventDefault();
      alert('New passwords do not match');
      return;
    }
    
    if (newPassword.length < 6) {
      e.preventDefault();
      alert('New password must be at least 6 characters long');
      return;
    }
  });
  
  // Delete account validation
  document.getElementById('deleteAccountForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    if (!password) {
      e.preventDefault();
      alert('Please enter your password to confirm account deletion');
    }
  });
  
  // Load blocked users and account stats
  loadBlockedUsers();
  loadAccountStats();
  
  // Handle help modal
  document.querySelectorAll('[data-help]').forEach(link => {
    link.addEventListener('click', function() {
      const helpType = this.getAttribute('data-help');
      loadHelpContent(helpType);
    });
  });
  
  // Handle about modal
  document.querySelectorAll('[data-about]').forEach(link => {
    link.addEventListener('click', function() {
      const aboutType = this.getAttribute('data-about');
      loadAboutContent(aboutType);
    });
  });
  
  async function loadBlockedUsers() {
    try {
      const response = await fetch('/api/users/blocked');
      if (!response.ok) throw new Error('Failed to load blocked users');
      
      const users = await response.json();
      const container = document.getElementById('blockedUsers');
      
      if (users.length === 0) {
        container.innerHTML = '<p class="text-muted">No blocked users</p>';
        return;
      }
      
      container.innerHTML = '';
      users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = 'border-bottom p-2';
        
        userElement.innerHTML = `
          <div class="d-flex align-items-center">
            <img src="${user.avatar || '/images/default-avatar.png'}" class="rounded-circle me-2" width="40" height="40" alt="${user.username}">
            <div class="flex-grow-1">
              <strong>${user.username}</strong>
              <small class="text-muted d-block">${user.bio || ''}</small>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="unblockUser(${user.id}, this)">
              Unblock
            </button>
          </div>
        `;
        
        container.appendChild(userElement);
      });
      
    } catch (err) {
      console.error('Error loading blocked users:', err);
      document.getElementById('blockedUsers').innerHTML = 
        '<p class="text-danger">Failed to load blocked users</p>';
    }
  }
  
  async function unblockUser(userId, button) {
    try {
      const response = await fetch(`/api/users/${userId}/block`, {
        method: 'DELETE'
      });
      
      if (!response.ok) throw new Error('Failed to unblock user');
      
      button.closest('.border-bottom').remove();
      
      // Check if no more blocked users
      const container = document.getElementById('blockedUsers');
      if (container.children.length === 0) {
        container.innerHTML = '<p class="text-muted">No blocked users</p>';
      }
      
    } catch (err) {
      console.error('Unblock error:', err);
      alert('Failed to unblock user. Please try again.');
    }
  }
  
  async function loadAccountStats() {
    try {
      const response = await fetch('/api/users/<%= user.username %>');
      if (response.ok) {
        const data = await response.json();
        document.getElementById('userPostsCount').textContent = data.posts.length;
        
        // Get followers/following counts
        const followersResponse = await fetch('/api/users/<%= user.id %>/followers');
        const followingResponse = await fetch('/api/users/<%= user.id %>/following');
        
        if (followersResponse.ok && followingResponse.ok) {
          const followers = await followersResponse.json();
          const following = await followingResponse.json();
          
          document.getElementById('userFollowersCount').textContent = followers.length;
          document.getElementById('userFollowingCount').textContent = following.length;
        }
      }
    } catch (err) {
      console.error('Error loading account stats:', err);
      document.getElementById('userPostsCount').textContent = 'Error';
      document.getElementById('userFollowersCount').textContent = 'Error';
      document.getElementById('userFollowingCount').textContent = 'Error';
    }
  }
  
  function loadHelpContent(type) {
    const helpContent = {
      privacy: `
        <h6>Privacy & Security</h6>
        <p><strong>Private Account:</strong> When your account is private, only approved followers can see your posts.</p>
        <p><strong>Blocking Users:</strong> Blocked users cannot see your profile, posts, or send you messages.</p>
        <p><strong>Password Security:</strong> Use a strong password and change it regularly.</p>
      `,
      account: `
        <h6>Account Management</h6>
        <p><strong>Profile Settings:</strong> Update your username, bio, and profile picture anytime.</p>
        <p><strong>Email Changes:</strong> Verify your email when making changes to your account.</p>
        <p><strong>Account Deletion:</strong> This action is permanent and cannot be undone.</p>
      `,
      posting: `
        <h6>Posting & Sharing</h6>
        <p><strong>Creating Posts:</strong> Share text, images, and videos with your followers.</p>
        <p><strong>Privacy Controls:</strong> Choose who can see your posts based on your account settings.</p>
        <p><strong>Content Guidelines:</strong> Keep posts respectful and follow community standards.</p>
      `,
      blocking: `
        <h6>Blocking & Reporting</h6>
        <p><strong>Blocking Users:</strong> Block users to prevent them from seeing your content or contacting you.</p>
        <p><strong>Unblocking:</strong> You can unblock users anytime from your settings.</p>
        <p><strong>Reporting:</strong> Report inappropriate content or behavior to keep the community safe.</p>
      `
    };
    
    document.getElementById('helpModalBody').innerHTML = helpContent[type] || '<p>Help content not available.</p>';
  }
  
  function loadAboutContent(type) {
    const aboutContent = {
      terms: `
        <h6>Terms of Service</h6>
        <p>By using Social App, you agree to our terms and conditions.</p>
        <ul>
          <li>Use the platform responsibly and respectfully</li>
          <li>Do not share inappropriate or harmful content</li>
          <li>Respect other users' privacy and rights</li>
          <li>Follow all applicable laws and regulations</li>
        </ul>
      `,
      privacy: `
        <h6>Privacy Policy</h6>
        <p>We are committed to protecting your privacy and personal information.</p>
        <ul>
          <li>We collect only necessary information to provide our services</li>
          <li>Your data is encrypted and stored securely</li>
          <li>We do not sell your personal information to third parties</li>
          <li>You can delete your account and data at any time</li>
        </ul>
      `,
      contact: `
        <h6>Contact Us</h6>
        <p>Need help or have questions? We're here to assist you.</p>
        <p><strong>Email:</strong> support@socialapp.com</p>
        <p><strong>Response Time:</strong> We typically respond within 24 hours</p>
        <p><strong>Support Hours:</strong> Monday - Friday, 9 AM - 6 PM</p>
      `,
      version: `
        <h6>App Information</h6>
        <p><strong>Version:</strong> 1.0.0</p>
        <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>Platform:</strong> Web Application</p>
        <p><strong>Developer:</strong> Social App Team</p>
      `
    };
    
    document.getElementById('aboutModalBody').innerHTML = aboutContent[type] || '<p>Information not available.</p>';
  }
</script>

<%- include('partials/footer') %>